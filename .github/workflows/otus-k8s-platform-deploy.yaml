name: Otus Kubernetes Platform deploy

on:
  push:
    branches: [master]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    env:
      TF_VAR_cloud_id: ${{ secrets.cloud_id }}
      TF_VAR_folder_id: ${{ secrets.folder_id }}
      TF_VAR_sa_id: ${{ secrets.service_account_id }}
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3  
        
      - name: Decode Service Account Key and save as key.json
        working-directory: terraform
        uses: jsdaniell/create-json@1.1.2
        with:
          name: "key.json"
          json: ${{ secrets.SERVICE_ACCOUNT_KEY }}
          
      - name: Install Yandex Cloud CLI
        run: |
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
          echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH
          
      - name: Authenticate with Yandex Cloud
        run: |
          export PATH="$HOME/yandex-cloud/bin:$PATH"
          yc config set service-account-key ${GITHUB_WORKSPACE}/terraform/key.json
          yc config set ${{ secrets.cloud_id }}
          yc config set folder-id ${{ secrets.folder_id }}